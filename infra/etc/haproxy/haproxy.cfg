global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  5000ms
    timeout server  5000ms
    timeout http-request 5s
    timeout http-keep-alive 10s
    option  forwardfor
    option  http-server-close

# frontend for http (redirected to https)
frontend http_frontend
    bind *:80

    acl valid_host hdr(host) -i api.mfirhas.com
    
    http-request redirect scheme https code 301 if valid_host

    http-request deny deny_status 403

# Frontend - API Gateway to backends
frontend api_gateway
    bind *:443 ssl crt /etc/haproxy/certs/api.mfirhas.com.pem alpn h2,http/1.1

    # check if host is valid
    acl valid_host hdr(host) -i api.mfirhas.com
    http-request deny deny_status 403 if !valid_host
    
    # Request rate limiting (optional)
    # Create a stick table to track request rates by IP address
    # - type ip: track by source IP
    # - size 500k: store up to 500,000 IP addresses
    # - expire 30s: entries expire after 30 seconds of inactivity
    # - store http_req_rate(10s): sliding window for 10 seconds
    stick-table type ip size 500k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }
    
    # ACLs
    acl is_health_check path /health
    acl is_pfm_api path_beg /pfm
    acl is_kartel_webhook path_beg /webhook
    acl is_kartel_api path_beg /kartel

    # Security Headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-XSS-Protection "1; mode=block"

    # backend endpoints
    use_backend health_backend if is_health_check
    use_backend pfm_backend if is_pfm_api
    use_backend kartel_backend_webhook if is_kartel_webhook
    use_backend kartel_backend_api if is_kartel_api
    
    # default backend
    default_backend default_backend

## backends
backend pfm_backend
    balance roundrobin
    ## strip the /pfm prefix from acl
    http-request set-path %[path,regsub(^/pfm,)]
    # option httpchk GET /health
    # http-check expect status 200
    server pfm 127.0.0.1:1994 check

backend kartel_backend_webhook
    balance roundrobin
    server pfm 127.0.0.1:1995 check

backend kartel_backend_api
    balance roundrobin
    http-request set-path %[path,regsub(^/kartel,)]
    server pfm 127.0.0.1:1996 check

backend health_backend
    http-request return status 200 content-type text/plain string "OK"

backend default_backend
    http-request deny deny_status 404


## Statistics page (optional)
# listen stats
#     bind *:8404
#     stats enable
#     stats uri /stats
#     stats refresh 30s
#     stats show-node


