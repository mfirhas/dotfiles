global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    option  forwardfor
    option  http-server-close

# frontend for http to https
frontend http_frontend
    bind *:80
    
    # Redirect ALL traffic to HTTPS
    http-request redirect scheme https code 301

# Frontend - API Gateway listening on port 9000
frontend api_gateway
    bind *:443 ssl crt /etc/haproxy/certs/api.mfirhas.com.pem alpn h2,http/1.1

    # Security Headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-XSS-Protection "1; mode=block"
    
    # Request rate limiting (optional)
    # Create a stick table to track request rates by IP address
    # - type ip: track by source IP
    # - size 500k: store up to 500,000 IP addresses
    # - expire 30s: entries expire after 30 seconds of inactivity
    # - store http_req_rate(10s): count requests in 10-second windows
    stick-table type ip size 500k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny if { sc_http_req_rate(0) gt 50000 }
    
    # ACLs
    acl is_health_check path /health
    acl is_pfm_api path_beg /pfm

    # backend endpoints
    use_backend health_backend if is_health_check
    use_backend pfm_backend if is_pfm_api
    
    # default backend
    default_backend default_backend

## backends
backend pfm_backend
    balance roundrobin
    ## strip the /pfm prefix from acl
    http-request set-path %[path,regsub(^/pfm,)]
    option httpchk GET /health
    http-check expect status 200
    server pfm 127.0.0.1:3000 check

backend health_backend
    http-request return status 200 content-type text/plain string "OK"

backend default_backend
    http-request deny deny_status 404


## Statistics page (optional)
# listen stats
#     bind *:8404
#     stats enable
#     stats uri /stats
#     stats refresh 30s
#     stats show-node
